#!/usr/bin/env zsh
set -euo pipefail

# Generate a .creds.env file with AWS credentials
# Sources:
# - Environment variables in the current shell
# - (Optional) You can export explicit env vars; profiles are not read
#
# Usage:
#   ./script/creds            # writes .creds.env in repo root
#   AWS_PROFILE=clay ./script/creds

OUT_FILE=".creds.env"

echo "# Generated $(date -u +%Y-%m-%dT%H:%M:%SZ)" > "$OUT_FILE"

# Region precedence: AWS_REGION > AWS_DEFAULT_REGION
REGION_VALUE="${AWS_REGION:-${AWS_DEFAULT_REGION:-}}"
if [[ -n "$REGION_VALUE" ]]; then
  echo "AWS_REGION=$REGION_VALUE" >> "$OUT_FILE"
  echo "AWS_DEFAULT_REGION=$REGION_VALUE" >> "$OUT_FILE"
fi

# If explicit env keys exist, write them
[[ -n "${AWS_ACCESS_KEY_ID:-}" ]] && echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> "$OUT_FILE"
[[ -n "${AWS_SECRET_ACCESS_KEY:-}" ]] && echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> "$OUT_FILE"
[[ -n "${AWS_SESSION_TOKEN:-}" ]] && echo "AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> "$OUT_FILE"

# Profiles are not read; rely solely on explicit env vars
echo "Wrote $OUT_FILE"
